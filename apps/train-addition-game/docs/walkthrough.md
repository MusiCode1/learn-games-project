# יומן פיתוח - רכבת החיבור

## 2026-02-22 00:30

### שכתוב מנגנון האודיו - Web Audio API Cache + חיתוך שקט

שכתוב מלא של `tts.ts` למנגנון מבוסס `AudioBuffer` cache בזיכרון, הסרת קוד ישן ותמיכת WAV, וחיתוך שקט מקבצי המספרים והמילים.

#### מה בוצע?

**1. מעבר ל-Web Audio API עם AudioBuffer Cache**

- `preloadAllAssets()` שוכתב לטעון כל קובץ MP3 פעם אחת בלבד דרך `fetch` + `decodeAudioData`, ולשמור `AudioBuffer` מפוענח ב-`Map` בזיכרון.
- הטעינה מקבילית (`Promise.allSettled`) - כל הקבצים נטענים בו-זמנית.
- קריאה כפולה בטוחה - Promise נשמר ב-`preloadDone` למניעת טעינה כפולה.
- `playBuffer()` חדש: משמיע `AudioBuffer` מ-cache מיידית דרך `BufferSource` (ללא latency).
- `playAsset()` שוכתב לשני שלבים בלבד: cache → fallback TTS.

**2. הסרת קוד ישן וניקוי**

- `tryPlayFile()` ו-`playAudioFile()` נמחקו לגמרי.
- הוסרה תמיכת WAV מ-`tts.ts` (כל הקבצים הם MP3; `error.wav` ב-`sound.ts` הוא UI sound נפרד).
- `playSequence()` פושט - מקבל כעת `VoiceKey[]` ישיר במקום `{ key?, text? }[]`.

**3. שאלה מפורטת מ-cache**

- נוספו `how_many_is` ו-`trains_plus` ל-`VOICE_ASSETS` (קבצים `how_many_is.mp3`, `trains_plus.mp3` - עדיין לא הוקלטו, יפלו ל-TTS עד אז).
- `speakChooseAnswer` ו-`speakWrong` משמיעים כעת "כמה זה → X → רכבות, ועוד → Y" כרצף מ-cache במקום TTS חי.

**4. חיתוך שקט מקבצי אודיו**

- חותך שקט מ-29 קבצים: מספרים `1-20.mp3` + מילות קישור (`plus`, `equals`, `add`, `cars`, `put`, `correct`, `well_done`, `wrong`, `try_again`).
- כלי: `ffmpeg silenceremove` עם סף -45dB, 100ms padding בסוף.
- תוצאה: קבצים הוקטנו ב-74–89% (למשל `2.mp3`: 46.5KB → 5.2KB).
- גיבויים נשמרו ב-`static/sounds/backup/`.

#### החלטות ארכיטקטורה

- **Web Audio API במקום HTMLAudioElement**: `AudioBuffer` מפוענח בזיכרון = השמעה מיידית ללא latency. יצירת `BufferSource` מ-buffer קיים זולה מאוד לעומת `new Audio()` שדורשת decode מחדש בכל פעם.
- **MP3 בלבד (ללא WAV fallback בזמן ריצה)**: כל הקלטות הן MP3 כיום. ניסיון WAV בזמן ריצה היה overhead מיותר.
- **fallback ל-TTS בלבד (ללא fallback ביניים של `new Audio()`)**: קוד נקי יותר; אם הקובץ לא נטען ל-cache, TTS הוא הגיבוי הנכון.

#### קבצים ששונו

- `src/lib/utils/tts.ts` - שכתוב מלא
- `static/sounds/*.mp3` - 29 קבצים עם חיתוך שקט

---

## 2026-02-19 23:30

### שילוב קבצי אודיו מ-ElevenLabs + Preload

העברת קבצי אודיו חדשים (MP3) שנוצרו ב-ElevenLabs לתיקיית הסאונד, עדכון מנגנון הטעינה ב-`tts.ts` לתמיכה בשתי סיומות, והוספת preload לא-חוסם.

#### מה בוצע?

**1. העברת קבצי ElevenLabs**

- 39 קבצי MP3 הועברו מ-`ElevenLabs_Untitled_project` לתיקיית `static/sounds` עם שמות תואמים לפי הסדר ב-`docs/elevenlabs_raw_text.txt`.
- המיפוי הנכון: קובץ `01` = **אחד** (אפס לא הוקלט ב-ElevenLabs), כל השמות תוקנו בהתאם.
- קבצים קיימים גובו לתיקיית `static/sounds/backup` לפני ההחלפה.
- קבצים חדשים: `1.mp3`–`20.mp3`, `plus.mp3`, `equals.mp3`, `put.mp3`, `add.mp3`, `cars.mp3`, `put_1_cars.mp3`–`put_5_cars.mp3`, `add_1_cars.mp3`–`add_4_cars.mp3`, `how_many.mp3`, `correct.mp3`, `well_done.mp3`, `wrong.mp3`, `try_again.mp3`.

**2. עדכון `tts.ts` - ללא סיומות ב-`VOICE_ASSETS`**

- שדה `file` ב-`VOICE_ASSETS` הוסרה ממנו הסיומת לחלוטין (למשל `"correct"` במקום `"correct.wav"`).
- שמות קבצי המספרים שונו מ-`num_0` ל-`0`, מ-`num_1` ל-`1` וכו' - כדי לתאום לשמות הקבצים שהועברו.
- `playAudioFile` עודכן לנסות אוטומטית `.wav` ואחר כך `.mp3` - כך שקבצי WAV קיימים ממשיכים לעבוד, ו-MP3 חדשים מוצאים כ-fallback.

**3. Preload לא-חוסם**

- נוספה פונקציה `preloadAllAssets()` ב-`tts.ts` שעוברת על כל ה-`VOICE_ASSETS` וטוענת כל קובץ MP3 לזיכרון הדפדפן ברקע.
- משתמשת ב-`requestIdleCallback` (או `setTimeout` כ-fallback) - לא חוסמת את טעינת הדף.
- הפונקציה נקראת מ-`+layout.svelte` בתוך `onMount`.

#### החלטות ארכיטקטורה

- **ללא סיומת ב-VOICE_ASSETS**: במקום לעדכן את כל שמות הקבצים בכל פעם שמחליפים פורמט, ה-`file` מכיל שם בלבד, ו-`playAudioFile` מוסיף סיומות לפי סדר עדיפות (`.wav` ראשון, `.mp3` שני) - מאפשר מעבר הדרגתי בין פורמטים.

#### קבצים ששונו

- `src/lib/utils/tts.ts`
- `src/routes/+layout.svelte`

---

## 2026-02-11 17:45

### שיפורי TTS ומשוב מפורט

שדרוג משמעותי למערכת ההקראה והמשוב הקולי, כולל תמיכה באודיו מקוטע (Segmented Audio) וחזרה על השאלה בעת טעות.

#### מה בוצע?

**1. מקור אמת יחיד (`VOICE_ASSETS`)**

- כל נכסי האודיו (קבצים) והטקסטים (TTS) אוחדו לאובייקט אחד ב-`src/lib/utils/tts.ts`.
- המערכת יודעת אוטומטית להשתמש בקובץ סאונד אם קיים, ולבצע Fallback ל-TTS אם חסר.

**2. משוב הצלחה מפורט**

- בעת תשובה נכונה, המערכת מרכיבה משפט דינמי: "נכון!" -> "3" -> "ועוד" -> "3" -> "שווה" -> "6" -> "כל הכבוד!".
- זה מחליף את המשפט הגנרי ומספק חיזוק לימודי טוב יותר.

**3. חזרה על השאלה בעת טעות**

- אם ההגדרה "שאלה מפורטת" פעילה, לאחר משוב שלילי ("לא נכון"), המערכת משמיעה שוב את השאלה ("כמה זה X ועוד Y?") כדי לעזור לילד לזכור את התרגיל.

**4. יצירת סקריפטים ל-ElevenLabs**

- נוצרו קבצי עזר (`docs/elevenlabs_scripts.md`, `docs/elevenlabs_raw_text.txt`) עם פרומפטים מוכנים ליצירת כל קבצי האודיו הדרושים ב-ElevenLabs v3.

#### קבצים ששונו

- `src/lib/utils/tts.ts`
- `src/lib/stores/game-state.svelte.ts`
- `docs/elevenlabs_scripts.md` (חדש)
- `docs/elevenlabs_raw_text.txt` (חדש)

---

## 2026-01-15 21:30

### תיקון לחיצות כפולות על כפתור המחזק

נוסף מנגנון השבתה מיידית של כפתור המחזק לאחר לחיצה אחת, למניעת הפעלות כפולות כשהתלמיד חוזר מהמחזק.

#### מה בוצע?

**1. מניעת לחיצות כפולות**

- הוספת משתנה מצב `isRewardPending` למעקב אחר לחיצה על כפתור הפרס.
- השבתת הכפתור מיידית עם הלחיצה (`disabled={isRewardPending}`).
- הוספת `$effect` לאיפוס המצב כשיוצאים ממצב `REWARD_TIME`.

**2. משוב ויזואלי**

- הוספת עיצוב למצב מושבת: שקיפות 50%, סמן "לא זמין", והסרת אפקטי hover.

#### קבצים ששונו

- `src/routes/game/+page.svelte`

---

## 2025-12-24 19:30

### סידור מבנה קומפוננטות (Co-location)

בוצע ארגון מחדש של מבנה הקומפוננטות בהתאם לעיקרון Co-location - מיקום קומפוננטות ייחודיות לדף בתוך תיקיית `_components`.

#### מה בוצע?

**1. העברת קומפוננטות**

- 8 קומפוננטות הועברו מ-`src/lib/components` ל-`src/routes/game/_components`:
  `GameWorld`, `TrainTrackArea`, `TrainCar`, `AnswerPanel`, `DepotArea`, `FeedbackOverlay`, `InstructionPanel`, `CounterBadge`
- `SettingsControls` הועבר ל-`src/routes/settings/_components`
- נשאר רק `HeaderBar` ב-`src/lib/components` (משותף)

**2. עדכון imports**

- עודכנו כל ה-imports בדפי +page.svelte לנתיבים יחסיים

#### החלטות ארכיטקטורה

- **בחירה בתיקיית `_components`**: נבחר להשתמש בתיקייה מקוננת (`_components`) ולא שטוחה כי יש 8 קומפוננטות, וזה שומר על הראוט נקי וברור.

---

## 2025-12-22 14:50

### הושלמה גרסה v0.5 - ניהול הגדרות ומצבי משחק

הושלם מהלך נרחב של שדרוג תשתית ההגדרות והוספת מצבי משחק חדשים.

#### מה בוצע?

**1. ניהול הגדרות וממשק משתמש**

- נוצר דף הגדרות ייעודי (`/settings`) המחליף את ה-Overlay הישן.
- פותח רכיב `SettingsControls` המאחד את כל הגדרות המשחק והבוסטר במקום אחד.
- הוספה יכולת גלילה לדף ההגדרות לתמיכה במסכים קטנים.
- עודכן ה-`HeaderBar` לניווט ישיר לדף ההגדרות.

**2. לוגיקת משחק (Game Logic)**

- נוספו שני מצבי משחק חדשים:
  - **רציף (Continuous):** מעבר אוטומטי לחיזוק ולשלב הבא ללא התערבות.
  - **ידני (Manual End):** עצירה בסיום שלב והצגת כפתור "שחק שוב".
- תוקן באג בו הבוסטר לא הופעל אוטומטית במצב רציף.
- עודכנה מכונת המצבים (`GameState`) לתמיכה ב-`LEVEL_END`.

**3. תשתית ובדיקות**

- שודרג ה-`SettingsStore` לשמירת מצבי משחק ומיגרציה מגרסאות קודמות.
- נכתבו בדיקות E2E חדשות (`settings.spec.ts`, `game.spec.ts`) המכסות:
  - ניווט ושינוי הגדרות.
  - זרימת משחק מלאה בשני המצבים.
  - תיקוני באגים וגלילה.

---

## 20/12/2025 03:25

### 🧪 הקמת מערך בדיקות מקיף (Vitest + Playwright)

נוספה תשתית בדיקות מלאה לפרויקט, המכסה הן את הלוגיקה העסקית והן את חווית המשתמש והרספונסיביות.

#### מה בוצע?

**1. בדיקות יחידה (Unit Tests) - Vitest**

- **כיסוי:** `src/tests/unit/gameState.test.ts`
- **תוכן:** אימות הלוגיקה של `game-state.svelte.ts`:
  - אתחול משחק תקין.
  - מעברים בין שלבים (`BUILD_A` -> `ADD_B` -> `CHOOSE_ANSWER`).
  - טיפול נכון בתשובות (ניקוד חיובי vs ענישה/Cooldown).

**2. בדיקות קצה-לקצה (E2E) - Playwright**

- **כיסוי:** `src/tests/e2e/game.spec.ts`
- **Happy Path:** הרצת סיבוב משחק מלא (הוספת קרונות, מענה נכון).
- **תרחישי שגיאה:** וידוא הופעת משוב שגיאה (Overlay כתום) בעת טעות.
- **רספונסיביות:** בדיקה שהאלמנטים הקריטיים (כמו רכבת ופאנל תשובות) מוצגים כראוי ב-Mobile (320px) וב-Desktop.

## 20/12/2025 01:40

### 🚂 עיצוב רספונסיבי וליטוש חווית משתמש (Responsive Design Polish)

בוצעו התאמות מקיפות לוודא שהמשחק נראה ועובד מצוין בכל גודל מסך, עם דגש מיוחד על הצמדת הרכבת לקרקע ותמיכה במכשירים קטנים.

#### מה בוצע?

**1. ממשק ורספונסיביות**

- **עיגון הרכבת:** הרכבת כעת "יושבת" באופן אבסולוטי בתחתית המסך, ללא תלות באלמנטים אחרים, מה שמבטיח שהיא תמיד על הדשא ולא "מרחפת".
- **חיתוך קרקע חכם:** במסכים קטנים (Mobile), גובה הקרקע צומצם משמעותית ושכבת האדמה הוסתרה כדי לחסוך מקום יקר.
- **מצב קומפקטי (Compact Mode):** מסכים צרים (עד 320px) מציגים כעת גרסה מוקטנת של פאנל התשובות והוראות המשחק.
- **הסתרת בועות:** במובייל, בזמן שלב המענה ("כמה קרונות?"), בועות החישוב של השלב הקודם מוסתרות כדי למנוע עומס וחפיפה.
- **תיקון Feedback Overlay:** שכבת המשוב הועברה ל-Root של הדף ותוקנה בעיית Z-Index שמנעה את הופעתה במובייל.

**2. רכיבים**

- **AnswerPanel:** תצוגה דינמית המשתנה משורה אחת (Desktop) לשתי שורות (Mobile) באופן אוטומטי.
- **TrainTrackArea:** הקטנת גודל האלמנטים (בועות מספר, קרונות) במובייל למניעת גלישה.

## 18/12/2025 17:40

### 🧪 עיצוב מחדש של ה-UI, ארגון Router ושיפורי יציבות

בוצע שדרוג מקיף לחווית המשתמש ולמבנה האפליקציה, במטרה ליצור חוויה יציבה יותר ומונגשת.

#### מה בוצע?

**1. ממשק משתמש (UI/UX)**

- **יציבות תצוגה (Layout Stability):** הטמעת מנגנון "פלייסהולדרים" (באמצעות `invisible`) לרכיבים מרכזיים כמו `AnswerPanel`, כדי למנוע קפיצות במסך בעת שינויי מצב משחק.
- **וידג'ט התקדמות:** הוזז לראש המסך (במרכז), בתצורה אופקית, כדי לא להסתיר אלמנטים.
- **כפתורים ושליטה:**
  - כפתור "הוסף קרון" (Depot) מופיע בנפרד רק כשרלוונטי.
  - כפתור "השמע" עגול ומינימליסטי יותר.
  - כפתור "הגדרות" ו-"בית" בעיצוב חדש עם אייקונים.
- **פאנל תשובות:** תצוגת Grid (2 שורות של 5) במסכים צרים לשיפור הנוחות.
- **טיפול בגלילה:** הגדרת `h-screen` וצמצום מרווחים למניעת גלילה מיותרת.

**2. ארכיטקטורה (Routing)**

- **פיצול עמודים:**
  - `src/routes/+page.svelte` - מסך פתיחה ("לובי") בלבד.
  - `src/routes/game/+page.svelte` - מסך המשחק הראשי.
- **Layout משותף:**
  - `src/routes/+layout.svelte` מכיל כעת את האלמנטים הקבועים: רקע (עננים), Header Bar, ו-Settings Overlay.

**3. רכיבים וקוד**

- **סנכרון סאונד:** מעבר ל-`async/await` ומנגנון Promise להשמעת TTS/Audio למניעת חפיפות.
- **ניקוי:** הסרת `AssistOverlay` (פופאפ עזרה) שהפריע, והסרת טקסטים כפולים.
- **דיבאג:** הוספת `window.GameDebug` לבדיקות קלות בקונסול.

## 17/12/2025 - יצירת הפרויקט

### 🚀 מה נוצר

**תשתית**

- אפליקציית SvelteKit עם Tailwind CSS ו-TypeScript

**לוגיקה**

- `game-state.svelte.ts` - State Machine
- `settings.svelte.ts` - הגדרות מורה
- `tts.ts` - הקראה עם fallback ל-TTS
- `distractors.ts` - יצירת מסיחים

**רכיבי UI**

- TrainCar, TrainTrackArea, DepotArea
- HeaderBar, InstructionPanel, AnswerPanel
- CounterBadge, FeedbackOverlay, AssistOverlay

**קבצים סטטיים**

- SVG: locomotive, car-green, car-blue
- סאונד: 13 קבצי WAV

### ✨ תכונות

- cooldown 10 שניות עם טיימר
- מספרים דינמיים + סימן חיבור
- ספרות 1-10 לבחירה
- אנימציות מושכות
